---
title: "COVID-19 Canada Testing"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: cosmo
    includes:
      after_body: footer.html
---

```{r setup, echo=FALSE,results='hide',message = FALSE, warning = FALSE}

# setwd("C:/DB Mount/GitHub/Testing_Dash") #for Kuan only;

#------------------ Packages ------------------
library(shiny) #shiny app;
library(flexdashboard) #dashboard;
library(dplyr) #data tool;
library(RCurl) #read data url;
library(plotly) #visual tool;
library(tibble) #scrap variable characters;
library(DT) #Datatable;

#------------------ Data is generated by running the data clean script ------------------
#------------------ Read all data ------------------

can<-read.csv("docs/can.csv", header = TRUE, sep = ",", encoding = 'UTF-8')
can$date_report<-as.Date(can$date_report,format="%Y-%m-%d")
prov<-read.csv("docs/prov.csv", header = TRUE, sep = ",", encoding = 'UTF-8')
prov$date_report<-as.Date(prov$date_report,format="%Y-%m-%d")

df_trajectory<-read.csv("docs/df_trajectory.csv", header = TRUE, sep = ",", encoding = 'UTF-8')
df_trajectory_can<-read.csv("docs/df_trajectory_can.csv", header = TRUE, sep = ",", encoding = 'UTF-8')



#------------------ creating New bubble map data;  ------------------
# instead of using polygon maps, we will display bubble map it reads faster;
# only information needed are the bubble centre lat and lng for each province and territory;
library(leaflet) #mapping;
canada_region<- prov[prov$date_report==max(prov$date_report)&prov$province != "Repatriated",]
canada_region$province<-factor(canada_region$province)
canada_region$lat<-c(53.9333, 49.2827, 53.7609, 46.5653, 53.1355, 44.6820, 70.2998, 64.8255, 51.2538, 46.5107, 52.9399, 52.9399, 64.2823)
canada_region$lng<-c(-116.5765, -123.1207,  -98.8139,  -66.4619,  -57.6604, -63.7443, -83.1076 ,-124.8457, -85.3232  ,-63.4168,  -73.5491, -106.4509, -135.0000)
# Prepare the text for the tooltip:
mytext <- paste(
   canada_region$province, "<br/>",
   "Confirmed Cases: ", canada_region$cumulative_cases, "<br/>", 
   "Active Cases: ", canada_region$active_cases, "<br/>", 
   "Deaths: ", canada_region$cumulative_deaths, "<br/>", 
   "Recovered: ", canada_region$cumulative_recovered, "<br/>", 
   "Total tested: ", canada_region$ccumulative_testing, "<br/>", 
   "Total tested per 1000 population: ", canada_region$cumulative_testing_per1000, sep="") %>%
  lapply(htmltools::HTML)

#------------------ data update time;  ------------------
date_update_date<-read.table("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/update_time.txt")
# date_update_date<-read.table("docs/data/update_time.txt")
data_date<-as_tibble(paste(date_update_date$V1, date_update_date$V2, date_update_date$V3))


#------------------ Parameters colours  ------------------
# Set colors
# https://www.w3.org/TR/css-color-3/#svg-color
#value box colour;
tested_color <- "#000000"
tested_color2 <- "#00008B"
positive_color <- "#DC143C"
active_color <- "#FFA500"
recovered_color <- "forestgreen"
death_color <- "#FF0000"
ab_color<-"#000000"
bc_color<-"#E69F00"
mb_color<-"#800000"
nb_color<-"#CC79A7"
nl_color<-"#56B4E9"
ns_color<-"#808000"
nt_color<-"#625D5D"
nu_color<-"#1589FF"
on_color<-"#009E73"
pe_color<-"#0000A0"
qc_color<-"#0072B2"
sk_color<-"#800080"
yt_color<-"#E56717"


```


Summary {data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------
### tested {.value-box}
```{r}
valueBox(value = paste(format(max(can$cumulative_testing, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Tested Cases", 
         icon = "fas fa-user-md", 
         color = tested_color)
```


### tested2 {.value-box}
```{r}
valueBox(value = paste(format(max(can$cumulative_testing_per1000, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Tested Cases per 1000", 
         icon = "fas fa-user-md", 
         color = tested_color2)
```


### Positive Cases {.value-box}

```{r}
valueBox(value = paste(format(max(can$cumulative_cases, na.rm = T), big.mark = ","), "", sep = " "), 
         caption = "Total Confirm Cases", 
         icon = "far fa-plus-square", 
         color = positive_color)
```


### Active {.value-box}
```{r}
activecase<-max(can$cumulative_cases, na.rm = T) - max(can$cumulative_recovered, na.rm = T) - max(can$cumulative_deaths, na.rm = T)
valueBox(value = paste(format(activecase, big.mark = ","), sep = ""),
         caption = "Active Cases", 
         icon = "fas fa-ambulance",
         color = active_color)
```

### recovered {.value-box}
```{r}
valueBox(value = paste(format(max(can$cumulative_recovered, na.rm = T), big.mark = ","), sep = ""),
         caption = "Recovered Cases", 
         icon = "fas fa-heartbeat", 
         color = recovered_color)
```

### death {.value-box}
```{r}
valueBox(value = paste(format(max(can$cumulative_deaths, na.rm = T), big.mark = ","), sep = ""),
         caption = "Deaths", 
         icon = "", 
         color = death_color)
```

Row
-----------------------------------------------------------------------

### Cumulative Number of Testing Completed in Canada

```{r}

```

### Daily New Number of Testing Completed in Canada


```{r}

```



Row
-----------------------------------------------------------------------

### Trajectory of Cumulative Testing in Canada Comparing to Other Countries

```{r}

plotly::plot_ly(data = df_trajectory) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ can1,
                    name = "Canada", connectgaps = TRUE, line = list(width = 4,color = "red")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ us1,
                    line = list(color = "black", width = 2),
                    name = "United States",connectgaps = TRUE) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ it1,
                    line = list(color = "#ec008c", width = 2),
                    name = "Italy",connectgaps = TRUE) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ uk1,
                    name = "United Kingdom", connectgaps = TRUE, line = list(width = 2,color = "green")) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ sko1,
                    line = list(color = "#00bcf2", width = 2),
                    name = "South Korea",connectgaps = TRUE) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ au1,
                    line = list(color = "brown", width = 2),
                    name = "Australia",connectgaps = TRUE) %>%
   plotly::layout(yaxis = list(title = "Cumulative Testing (log-scale)",type = "log"),
                 xaxis = list(title = "Days since the total deaths surpass 100"))

```



### Trajectory of Cumulative Testing per 1000 Population in Canada Comparing to Other Countries

```{r}

plotly::plot_ly(data = df_trajectory) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ can2,
                    name = "Canada",  line = list(width = 4,color = "red"),connectgaps = TRUE) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ us2,
                    line = list(color = "black", width = 2),
                    name = "United States",connectgaps = TRUE) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ it2,
                    line = list(color = "#ec008c", width = 2),
                    name = "Italy",connectgaps = TRUE) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ uk2,
                    name = "United Kingdom",  connectgaps = TRUE,line = list(width = 2,color = "green")) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ sko2,
                    line = list(color = "#00bcf2", width = 2),
                    name = "South Korea",connectgaps = TRUE) %>%
   plotly::add_lines(x = ~ index,
                    y = ~ au2,
                    line = list(color = "brown", width = 2),
                    name = "Australia",connectgaps = TRUE) %>%
   plotly::layout(yaxis = list(title = "Cumulative Testing per 1000 Population (log-scale)",type = "log"),
                 xaxis = list(title = "Days since the total deaths surpass 100"))

```


Row
-----------------------------------------------------------------------

### Trajectory of Cumulative Testing by Province

```{r}
plotly::plot_ly(data = df_trajectory_can) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ can1,
                    name = "Canada", connectgaps = TRUE, line = list(width = 4,color = "red")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ qc1,
                    name = "Quebec", connectgaps = TRUE, line = list(width = 2, color=qc_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ on1,
                    name = "Ontario",connectgaps = TRUE, line = list(width = 2, color=on_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ ab1,
                    name = "Alberta", connectgaps = TRUE, line = list(width = 2, color=ab_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ bc1,
                    name = "British Columbia", connectgaps = TRUE, line = list(width = 2, color=bc_color))%>%
  plotly::add_lines(x = ~ index,
                    y = ~ ns1,
                    name = "Nova Scotia", connectgaps = TRUE, line = list(width = 2,color = ns_color))%>%
   plotly::layout(yaxis = list(title = "Cumulative Testing (log-scale)",type = "log"),
                 xaxis = list(title = "Days since the total deaths surpass 50"))


```

### Trajectory of Cumulative Testing per 1000 Population by Province

```{r}
plotly::plot_ly(data = df_trajectory_can) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ can2,
                    name = "Canada", connectgaps = TRUE, line = list(width = 4,color = "red")) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ qc2,
                    name = "Quebec", connectgaps = TRUE, line = list(width = 2, color=qc_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ on2,
                    name = "Ontario",connectgaps = TRUE, line = list(width = 2, color=on_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ ab2,
                    name = "Alberta", connectgaps = TRUE, line = list(width = 2, color=ab_color)) %>%
  plotly::add_lines(x = ~ index,
                    y = ~ bc2,
                    name = "British Columbia", connectgaps = TRUE, line = list(width = 2, color=bc_color))%>%
  plotly::add_lines(x = ~ index,
                    y = ~ ns2,
                    name = "Nova Scotia", connectgaps = TRUE, line = list(width = 2,color = ns_color))%>%
   plotly::layout(yaxis = list(title = "Cumulative Testing (log-scale)",type = "log"),
                 xaxis = list(title = "Days since the total deaths surpass 50"))

```

Map
=======================================================================

Row 
-----------------------------------------------------------------------

### Geographic Mapping on Cumulative Testing per 1000 Population in Canada

```{r}

# Create a color palette with handmade bins.
mybins <- c(0,60,80,100,120,140,160,180, 200, Inf)
pal <- colorBin( palette="viridis", domain=canada_region$cumulative_testing_per1000, na.color="transparent", bins=mybins)

renderLeaflet({leaflet(canada_region) %>%
  addTiles() %>%
  setView(lat=55, lng=-100, zoom = 3) %>%
    addCircleMarkers(~lng, ~lat, fillColor = ~pal(cumulative_testing_per1000), fillOpacity = 0.7, color = "red",radius = ~sqrt(cumulative_testing_per1000)*2, stroke = T, weight=2,label = mytext, labelOptions = labelOptions( style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "12px", direction = "auto")) %>% addLegend( pal=pal, values=~cumulative_testing_per1000, opacity=0.9, title = "Cumulative Testing per 1000", position = "topright")})


```


Row 
-----------------------------------------------------------------------

### Canada COVID-19 Data by Province and Territory as of `r data_date$value`

```{r}


DT::renderDT(canada_region[,c(1,13,3,4,7,9,6,5,10,11,14)] %>%
  DT::datatable(rownames = FALSE,
                colnames = c("Region","Population","Daily New Cases","Cumulative Cases","Active Cases",
                             "Daily New Deaths", "Cumulative Deaths", "Cumulative Recovered", 
                             "Daily New Testing",
                             "Cumulative Testing","Cumulative Testing per 1000 Population"), options = list(order = list(1, 'desc'), searching = FALSE), filter = 'none'))
```




Canada Data
=======================================================================

```{r}
DT::renderDT(can[,c(1,4,7,5,6,11,14,12)] %>% 
  DT::datatable(rownames = FALSE,
                colnames = c("Date","Cumulative Cases","Active Cases", "Cumulative Recovered", "Cumulative Death", "Cumulative Testing", "Cumulative Testing per 1000","Testing Info"), options = list(searchHighlight = TRUE,  pageLength = 100), filter = 'top'))
```


About
=======================================================================


**Time of last data update:** `r data_date$value`


**Thank you for your interest in our COVID-19 data visualization project.** There are many great COVID-19 Canada dashboards available online. We have compiled the following list to show some of the dashboards that inspired us to build this one. 

- [The COVID-19 Canada Open Data Working Groups dashboard](https://art-bd.shinyapps.io/covid19canada/) developed by [Jean-Paul R. Soucy](https://twitter.com/JPSoucy) and [Isha Berry](https://twitter.com/ishaberry2), two amazing talented students from DLSPH.

- [Howsmyflattening dashboard](https://howsmyflattening.ca/#/home) by a group of researchers, students and volunteers lead by [Dr. Ali Vahit, Dr. Ben Fine and Dr. Laura Rosella](https://gitlab.com/howsmyflattening/www-howsmyflattening-ca/-/wikis/home). 

- [The Esri Canada COVID-19 Canada dashboard](https://resources-covid19canada.hub.arcgis.com/).

- [The PHAC COVID-19 Canada dashboard](https://experience.arcgis.com/experience/2f1a13ca0b29422f9b34660f0b705043/).


**Acknowledgement**

 - **Data** 
    - Canada data used in this dashboard are extracted from the data posted by the COVID-19 Canada Open Data Working Group (https://github.com/ishaberry/Covid19Canada) lead by [Jean-Paul R. Soucy](https://twitter.com/JPSoucy) and [Isha Berry](https://twitter.com/ishaberry2). Since April 1st, the working group collected and reported case and mortality data directly from Public Health Units. Thus, the case and mortality numbers reported may be higher than those from other sources, including the Ontario Ministry of Health. We direct readers to their dashboard website, [About the data section](https://art-bd.shinyapps.io/covid19canada/) for details.
    - **We want to express our sincere appreciation to all contributors of the COVID-19 Canada Open Data Working Group.** **Here is a list of contributors we want to pay special tribute to [Isha Berry](https://twitter.com/ishaberry2), [Jean-Paul R. Soucy](https://twitter.com/JPSoucy), [Kamal Acharya](https://twitter.com/Kamalraj_ach), [Gabrielle Brankston](https://twitter.com/GBrankston), [Vinyas Harish](https://twitter.com/VinyasHarish), Kathy Kornas, Thivya Naganathan, Lindsay Obress, [Meghan O'Neill](https://twitter.com/_MeghanONeill), [Tanya Rossi](https://twitter.com/DrTanyaRossi), [Alison Simmons](https://twitter.com/alisonesimmons), [Shelby Sturrock](https://twitter.com/shelbysturrock), Matthew Van Camp, [James E.Wright](https://twitter.com/JWright159) and Wendy Xie.**
    - World data used in this dashboard are from Our World In Data [website]( https://github.com/owid/covid-19-data/tree/master/public/data/).
 - **Special thanks** Our project mentor**[Dr. Eleanor Pullenayegum](https://twitter.com/EMPullenayegum)** at [Sickkids](http://www.sickkids.ca/AboutSickKids/Directory/People/P/Eleanor-Pullenayegum-staff-profile.html) for her support on all my COVID-19 projects! 
 
**We would not have made this dashboard if not for the work of the above team and individuals.** You can find the code of this dashboard at <https://github.com/Kuan-Liu/Testing_Dash>.


**Feedbacks**

Please feel free to reach me at kuan.liu@mail.utoronto.ca. You can also find me on [Twitter](https://twitter.com/KuanLiu2).



